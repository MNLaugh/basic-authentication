"use strict";function end_empty(){}function end_err(a,b){return a?a(new Error(b)):new Error(b)}function end_work(a,b,c){if(void 0===b)return a?a():!0;var d=http[b];return c&&(c.writeHead(b),c.end(d)),end_err(a,d)}function end_check(a,b){return a!=b}function end_check_file(a,b,c){var d,e=crypto(b),f=require("fs").readFileSync(c,{encoding:"utf8"}).match(/(.+)/g);d=f.length?f.length:0;var g=basic_legacy(a,!0),h=e.update(g.password).digest("hex");g=new RegExp("^"+g.user+":");for(var i=0;d>i;i++)if(g.test(f[i])){var j=f[i].substring(g.source.length-1);if(j===h)return!1}return!0}function basic_legacy(a,b){var c;return b===!0?(c=new Buffer(a,"base64").toString(),c=c.match(/^([^:]*):(.*)$/),{user:c[1],password:c[2]}):a.headers&&(c=a.headers.authorization)&&(c=c.match(reg))&&c[1]&&(c=new Buffer(c[1],"base64").toString().match(/^([^:]*):(.*)$/))?{user:c[1],password:c[2]}:Object.create(null)}function basic_small(a){var b;return a.headers&&(b=a.headers.authorization)&&reg.test(b)?b.substring(6):""}function authentication(a){function b(){return end_check=end_check_tmp,e.file&&(end_check=end_check_file),end_err=end_err_tmp,e.suppress&&(end_err=end_empty),function(a,b,c){var d=basic_small(a);return d?end_check(d,e.hash,e.file)?(b.setHeader("WWW-Authenticate",'Basic realm="'+e.realm+'"'),end_work(c,401)):e.agent&&e.agent!==a.headers["user-agent"]?end_work(c,403):end_work(c):(b.writeHead(401,{"WWW-Authenticate":'Basic realm="'+e.realm+'"'}),void b.end())}}function c(){return end_check=end_check_tmp,e.file&&(end_check=end_check_file),end_err=end_err_tmp,e.suppress&&(end_err=end_empty),function(a,b,c){var d=basic_small(a);return d?end_check(d,e.hash,e.file)?(b.setHeader("WWW-Authenticate",'Basic realm="'+e.realm+'"'),end_work(c,401,b)):e.agent&&e.agent!==a.headers["user-agent"]?end_work(c,403,b):end_work(c):(b.writeHead(401,{"WWW-Authenticate":'Basic realm="'+e.realm+'"'}),void b.end(http[401]))}}var d=a||Object.create(null),e={file:Boolean(d.file),agent:String(d.agent||""),realm:String(d.realm||"Authorization required"),suppress:Boolean(d.suppress)};if(e.file){if(e.hash=String(d.hash||"md5"),e.file=require("path").resolve(String(d.file)),!require("fs").existsSync(e.file)){var f=e.file+" not exists";throw new Error(f)}}else{var g=String(d.user||"admin"),h=String(d.password||"password");e.hash=new Buffer(g+":"+h).toString("base64")}return Boolean(d.legacy)?basic_legacy:Boolean(d.functions)?basic_small:(d.ending===!1?0:1)?c():b()}var reg=new RegExp(/^Basic (.*)$/),http=require("http").STATUS_CODES,crypto=require("crypto").createHash,end_err_tmp=end_err,end_check_tmp=end_check;module.exports=authentication;
