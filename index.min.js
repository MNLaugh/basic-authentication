/*
 * basic-authentication v1.5.3
 * (c) hex7c0 http://supergiovane.tk/#/basic-authentication
 * Licensed under GPLv3
 */
"use strict";function end_empty(){}function end_err(a,b){return a(new Error(b))}function end_work(a,b,c){if(void 0===b)try{return a()}catch(d){return!0}var e=http[b];c&&(c.writeHead(b),c.end(e));try{return end_err(a,e)}catch(d){return!1}}function end_check(a,b){return a!=b}function end_check_file(a,b,c){var d,b=crypto(b),e=require("fs").readFileSync(c,{encoding:"utf8"}).match(/(.+)/g);try{d=e.length}catch(f){d=0}var g=basic_legacy(a,!0),h=b.update(g.password).digest("hex");g=new RegExp("^"+g.user+":");for(var i=0;d>i;i++)if(g.test(e[i])){var j=e[i].substring(g.source.length-1);if(j===h)return!1}return!0}function basic_legacy(a,b){var c;return b===!0?(c=new Buffer(a,"base64").toString(),c=c.match(/^([^:]*):(.*)$/),{user:c[1],password:c[2]}):a.headers&&(c=a.headers.authorization)&&(c=c.match(reg))&&c[1]&&(c=new Buffer(c[1],"base64").toString(),c=c.match(/^([^:]*):(.*)$/))?{user:c[1],password:c[2]}:Object.create(null)}function basic_small(a){var b;return a.headers&&(b=a.headers.authorization)&&reg.test(b)?b.substring(6):""}var reg=new RegExp(/^Basic (.*)$/),http=require("http").STATUS_CODES,crypto=require("crypto").createHash,end_err_tmp=end_err,end_check_tmp=end_check;module.exports=function(a){function b(){return end_check=end_check_tmp,d.file&&(end_check=end_check_file),end_err=end_err_tmp,d.suppress&&(end_err=end_empty),function(a,b,c){var e;return(e=basic_small(a))?end_check(e,d.hash,d.file)?(b.setHeader("WWW-Authenticate",'Basic realm="'+d.realm+'"'),end_work(c,401)):d.agent&&d.agent!==a.headers["user-agent"]?end_work(c,403):end_work(c):(b.writeHead(401,{"WWW-Authenticate":'Basic realm="'+d.realm+'"'}),void b.end())}}function c(){return end_check=end_check_tmp,d.file&&(end_check=end_check_file),end_err=end_err_tmp,d.suppress&&(end_err=end_empty),function(a,b,c){var e;return(e=basic_small(a))?end_check(e,d.hash,d.file)?(b.setHeader("WWW-Authenticate",'Basic realm="'+d.realm+'"'),end_work(c,401,b)):d.agent&&d.agent!==a.headers["user-agent"]?end_work(c,403,b):end_work(c):(b.writeHead(401,{"WWW-Authenticate":'Basic realm="'+d.realm+'"'}),void b.end(http[401]))}}var a=a||Object.create(null),d={file:Boolean(a.file),agent:String(a.agent||""),realm:String(a.realm||"Authorization required"),suppress:Boolean(a.suppress)};if(d.file){if(d.hash=String(a.hash||"md5"),d.file=require("path").resolve(String(a.file)),!require("fs").existsSync(d.file)){var e=d.file+" not exists";throw new Error(e)}}else{var f=String(a.user||"admin"),g=String(a.password||"password");d.hash=new Buffer(f+":"+g).toString("base64")}return Boolean(a.legacy)?basic_legacy:Boolean(a.functions)?basic_small:(0==a.ending?0:1)?c():b()};
